<%- include('../../common/header', title) %>
<div id="loader"></div>
<style>
    .img-preview {
      max-width: 200px;
      position: relative;
      margin-top: 10px;
    }
    .img-preview img {
      width: 100%;
      border-radius: 6px;
      display: none;
    }
    .btn-close-preview {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(255, 255, 255, 0.8);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-weight: bold;
    }
    .file-info {
      font-size: 14px;
      margin-top: 5px;
      color: #555;
      display: none;
    }
  </style>
<div class="col-xl-12">
    <div class="tab-content text-muted mt-4 mt-md-0">
        <div class="card">
            <div class="card-body p-4">
                <form id="addCompany" action="<%= base_url + add_company %>" enctype="multipart/form-data">
                    <div class="row">
                        <!-- business type -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="businessType"
                                    class="form-label required_field"><%=__("Business Type") %><span
                                        class="text-danger"><%=__("*") %></span></label>
                                <select name="businessType" id="businessType" class="form-select">
                                    <option value><%=__("Select business type") %></option>
                                    <% companyType.forEach( item => { %>
                                    <option value="<%= item.id %>"><%= item.name %></option>
                                    <% }) %>
                                </select>
                                <span id="businessTypeError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <!-- business name -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="businessName"
                                    class="form-label required_field"><%=__("Business name") %><span
                                        class="text-danger"><%=__("*") %></span></label>
                                <input type="text" class="form-control" id="businessName" name="businessName"
                                    placeholder="<%=__("Business name") %>">
                                <span id="businessNameError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <!-- business email -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="businessEmail"
                                    class="form-label required_field"><%=__("Business Email") %><span
                                        class="text-danger"><%=__("*") %></span></label>
                                <input type="text" class="form-control" id="businessEmail" name="businessEmail"
                                    placeholder="<%=__("Business Email") %>">
                                <span id="businessEmailError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <!-- business phone -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="businessPhone"
                                    class="form-label required_field"><%=__("Business Phone Number") %><span
                                        class="text-danger"><%=__("*") %></span></label>
                                <input type="text" class="form-control" id="businessPhone" name="businessPhone"
                                    placeholder="<%=__("Business Phone Number") %>">
                                <span id="businessPhoneError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <!-- employee strength -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="employeeStrength"
                                    class="form-label required_field"><%=__("Employee Strength") %><span
                                        class="text-danger"><%=__("*") %></span></label>
                                <select name="employeeStrength" id="employeeStrength" class="form-select">
                                    <option value><%=__("Select Employee Strength") %></option>
                                    <% employeeStrength.forEach( item => { %>
                                    <option value="<%= item.id %>"><%= item.range_label %></option>
                                    <% }) %>
                                </select>
                                <span id="employeeStrengthError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <!-- busienss website -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="businessWebsite"
                                    class="form-label required_field"><%=__("Business Website") %></label>
                                <input type="text" class="form-control" id="businessWebsite" name="businessWebsite"
                                    placeholder="<%=__("Business Website") %>">
                                <span id="businessWebsiteError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <span class="mb-3">
                            <h5><%=__("Owner Person details") %></h5>
                        </span>
                        <!-- Contact Person name -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contactPersonName" class="form-label"><%=__("Contact Person Name") %><span
                                        class="text-danger"><%=__("*") %></span></label>
                                <input type="text" class="form-control" id="contactPersonName" name="contactPersonName"
                                    placeholder="<%=__("Contact Person Name") %>">
                                <span id="contactPersonNameError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <!-- Contact Person email -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contactPersonEmail" class="form-label"><%=__("Contact Person Email") %><span
                                        class="text-danger"><%=__("*") %></span></label>
                                <input type="text" class="form-control" id="contactPersonEmail"
                                    name="contactPersonEmail" placeholder="<%=__("Contact Person Email") %>">
                                <span id="contactPersonEmailError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <!-- Contact Person phone number -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contactPersonPhone"
                                    class="form-label"><%=__("Conatct Person Phone Number") %><span
                                        class="text-danger"><%=__("*") %></span></label>
                                <input type="text" class="form-control" id="contactPersonPhone"
                                    name="contactPersonPhone" placeholder="<%=__("Conatct Person Phone Number") %>">
                                <span id="contactPersonPhoneError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <!-- country -->
                        <div class="col-md-6 mb-3">
                            <label for="country" class="form-label required_field"><%=__("Country") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <select name="country" id="country" class="form-select country" data-type="reg">
                                <option value><%=__("Select Country") %></option>
                                <% country.forEach( item => { %>
                                <option value="<%= item.id %>"><%= item.name %></option>
                                <% }) %>
                            </select>
                            <span id="countryError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- state -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label required_field"><%=__("State") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <select class="form-select state" id="state" name="state"
                                data-placeholder="<%=__("Select state") %>" data-type="reg">
                                <option value><%=__("Select State") %></option>
                            </select>
                            <span id="stateError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- city -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label required_field"><%=__("City") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <select class="form-select city" id="city" name="city"
                                data-placeholder="<%=__("Select city") %>" data-type="reg">
                                <option value><%=__("Select City") %></option>
                            </select>
                            <span id="cityError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- address -->
                        <div class="col-md-6 mb-3">
                            <label for="example-url-input" class="form-label required_field"><%=__("Address") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <input type="text" class="form-control" id="address" name="address"
                                placeholder="<%=__("Address") %>" value="">
                            <span id="addressError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- postal code -->
                        <div class="col-md-6 mb-3">
                            <label for="example-url-input"
                                class="form-label required_field"><%=__("Postal Code") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <input type="text" class="form-control" id="postalCode" name="postalCode"
                                placeholder="<%=__("Postal Code") %>" value="">
                            <span id="postalCodeError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- same address -->
                        <div class="form-check mb-3">
                            <input type="checkbox" name="sameAddress" id="sameAddress" value="1">
                            <label class="form-check-label"
                                for="sameAddress"><%=__("Same as business address") %></label>
                        </div>
                        <span class="mb-3">
                            <h5><%=__("Operational address") %></h5>
                        </span>
                        <!-- Operational country -->
                        <div class="col-md-6 mb-3">
                            <label for="country" class="form-label required_field"><%=__("Country") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <select name="operationalCountry" id="country" class="form-select country" data-type="op">
                                <option value><%=__("Select Country") %></option>
                                <% country.forEach( item => { %>
                                <option value="<%= item.id %>"><%= item.name %></option>
                                <% }) %>
                            </select>
                            <span id="operationalCountryError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- Operational state -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label required_field"><%=__("State") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <select class="form-select state" id="operationalState" name="operationalState"
                                data-placeholder="<%=__("Select state") %>" data-type="op">
                                <option value><%=__("Select State") %></option>
                            </select>
                            <span id="operationalStateError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- Operational city -->
                        <div class="col-md-6 mb-3">
                            <label class="form-label required_field"><%=__("City") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <select class="form-select city operationalCity" id="operationalCity" name="operationalCity"
                                data-placeholder="<%=__("Select city") %>" data-type="op">
                                <option value><%=__("Select City") %></option>
                            </select>
                            <span id="operationalCityError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- Operational address -->
                        <div class="col-md-6 mb-3">
                            <label for="example-url-input" class="form-label required_field"><%=__("Address") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <input type="text" class="form-control operationalAddress" id="operationalAddress"
                                name="operationalAddress" placeholder="<%=__("Address") %>" value="">
                            <span id="operationalAddressError" class="text-danger errorRemove"></span>
                        </div>
                        <!--Operational  postal code -->
                        <div class="col-md-6 mb-3">
                            <label for="example-url-input"
                                class="form-label required_field"><%=__("Postal Code") %><span
                                    class="text-danger"><%=__("*") %></span></label>
                            <input type="text" class="form-control operationalPostalCode" id="operationalPostalCode"
                                name="operationalPostalCode" placeholder="<%=__("Postal Code") %>" value="">
                            <span id="operationalPostalCodeError" class="text-danger errorRemove"></span>
                        </div>
                        <span class="mb-3"> <h5><%=__("Business documents") %></h5></span>
                        <!-- tan number -->
                        <div class="form-check mb-3">
                            <input type="checkbox" name="company[tanNumberCheck]" id="tanNumberCheck" value="1">
                            <label class="form-check-label" for="tanNumberCheck"><%=__("TAN Number") %></label>
                        </div>
                        <div class="col-md-6 mb-3 tanNumber d-none">
                            <label for="tanNumber" class="form-label"><%=__("TAN Number") %></label>
                            <input type="text" class="form-control" id="tanNumber" name="company[tanNumber]"
                                placeholder="<%=__("TAN Number") %>" value="">
                            <span id="tanNumberError" class="text-danger errorRemove"></span>
                        </div>
                    </div>
                    <div class="row">    
                        <!-- GST Number -->
                        <div class="col-md-6 mb-3">
                            <label for="gstNumber"><%=__("GST Number") %><span class="text-danger"><%=__("*") %></span></label>
                            <input type="text" id="gstNumber" name="company[gstNumber]" class="form-control" placeholder="Enter GST Number">
                             <span id="company_gstNumberError" class="text-danger errorRemove"></span>
                        </div>
                         <!-- GST Upload -->
                        <div class="col-md-6 mb-3">
                            <label for="gstNumber"><%=__("GST Document") %></label>
                            <input type="file" class="form-control doc-upload" data-preview="#gstPreview" name="gstFile">
                            <div class="img-preview d-none" id="gstPreview">
                                <img src="" class="img-thumbnail" />
                                <div class="file-info"></div>
                                <button type="button" class="btn-close-preview">×</button>
                            </div>
                            <span id="gstFileError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- PAN Number -->
                        <div class="col-md-6 mb-3">
                            <label for="panNumber"><%=__("PAN Number") %><span class="text-danger"><%=__("*") %></span></label>
                            <input type="text" id="panNumber" name="company[panNumber]" id="panNumber" class="form-control" placeholder="Enter PAN Number">
                              <span id="company_panNumberError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- PAN Upload -->
                        <div class="col-md-6 mb-3">
                            <label for="panNumber"><%=__("PAN Document") %></label>
                            <input type="file" class="form-control doc-upload" data-preview="#panPreview" name="panFile">
                            <div class="img-preview d-none" id="panPreview">
                                <img src="" class="img-thumbnail" />
                                <div class="file-info"></div>
                                <button type="button" class="btn-close-preview">×</button>
                            </div>
                               <span id="panFileError" class="text-danger errorRemove"></span>
                        </div>
                        <!-- Aadhaar Front Upload -->
                        <div class="col-md-6 mb-3">
                            <label><%=__("Aadhaar Card (Front)") %><span class="text-danger"><%=__("*") %></span></label>
                            <input type="file" class="form-control doc-upload" data-preview="#aadhaarFrontPreview" name="aadhaarFront">
                            <div class="img-preview d-none" id="aadhaarFrontPreview">
                                <img src="" class="img-thumbnail" />
                                <div class="file-info"></div>
                                <button type="button" class="btn-close-preview">×</button>
                            </div>
                        </div>
                        <!-- Aadhaar Back Upload -->
                        <div class="col-md-6 mb-3">
                            <label><%=__("Aadhaar Card (Back)") %><span class="text-danger"><%=__("*") %></span></label>
                            <input type="file" class="form-control doc-upload" data-preview="#aadhaarBackPreview"
                                name="aadhaarBack">
                            <div class="img-preview d-none" id="aadhaarBackPreview">
                                <img src="" class="img-thumbnail" />
                                <div class="file-info"></div>
                                <button type="button" class="btn-close-preview">×</button>
                            </div>
                        </div>
                         <!-- website logo -->
                        <div class="col-md-6 mb-3">
                            <label><%=__("Website Logo") %></label>
                            <input type="file" class="form-control doc-upload" data-preview="#websiteLogoPreview"
                                name="websiteLogo" id="websiteLogo">
                            <div class="img-preview d-none" id="websiteLogoPreview">
                                <img src="" class="img-thumbnail" />
                                <div class="file-info"></div>
                                <button type="button" class="btn-close-preview">×</button>
                            </div>
                        </div>
                    </div>
                <button type="submit" class="btn btn-primary float-end"><%=__("Submit") %></button>
            </form>
        </div>
    </div>
</div>
</div>
<%- include('../../common/footer') %>
<script>
$(document).on('change', '.doc-upload', function () {
  const fileInput = this;
  const file = fileInput.files[0];
  const previewId = $(this).data('preview');
  const previewBox = $(previewId);
  const previewImg = previewBox.find('img');
  const previewText = previewBox.find('.file-info');
  const errorSpan = $(fileInput).siblings('span.text-danger');

  // Clear old messages
  errorSpan.text('');
  previewImg.hide().attr('src', '');
  previewText.text('').hide();
  previewBox.addClass('d-none');

  if (!file) return;

  const fileType = file.type;
  const fileName = file.name;
  const validImageTypes = ['image/jpeg', 'image/png', 'image/jpg'];
  const validPdfType = 'application/pdf';

  if (validImageTypes.includes(fileType)) {
    const reader = new FileReader();
    reader.onload = function (e) {
      previewImg.attr('src', e.target.result).show();
      previewText.hide();
      previewBox.removeClass('d-none');
    };
    reader.readAsDataURL(file);
  } else if (fileType === validPdfType) {
    previewImg.hide();
    previewText.text(`📄 ${fileName}`).show();
    previewBox.removeClass('d-none');
  } else {
    errorSpan.text('Only JPG, PNG, and PDF files are allowed.');
    $(fileInput).val('');
  }
});

$(document).on('click', '.btn-close-preview', function () {
  const previewBox = $(this).closest('.img-preview');
  previewBox.addClass('d-none');
  previewBox.find('img').attr('src', '').hide();
  previewBox.find('.file-info').text('').hide();

  const previewId = previewBox.attr('id');
  const fileInput = $(`input[data-preview="#${previewId}"]`);
  fileInput.val('');
  fileInput.siblings('span.text-danger').text('');
});

</script>



<script>
    $(document).ready(function () {
        $(setTimeout(() => $('#loader').hide(), 300));
        $('.country, .state, .city').select2({ placeholder: function () { return $(this).data('placeholder'); }, sorter: s => s.sort((a, b) => a.text.localeCompare(b.text)) });
        $(document).on('select2:open', () => {
            setTimeout(() => {
                document.querySelector('.select2-container--open .select2-search__field')?.focus();
            }, 0);
        })

        // get state
        $(document).on('change', '.country', function () {
            const type = $(this).data('type');
            const countryId = $(this).val();
            $.post(`<%= base_url + get_state %>`, { country: countryId }).done(res => {
                const options = res.state?.map(({ id, name }) => `<option value="${id}">${name}</option>`).join('') || '';
                $(`.state[data-type="${type}"]`).html(options);
                $(`.city[data-type="${type}"]`).html('<option value=""><%=__("Select City") %></option>'); // reset city
            });
        });

        // get city
        $(document).on('change', '.state', function () {
            const type = $(this).data('type');
            const stateId = $(this).val();
            $.post(`<%= base_url + get_city %>`, { state: stateId }).done(res => {
                const options = res.city?.map(({ id, name }) => `<option value="${id}">${name}</option>`).join('') || '';
                $(`.city[data-type="${type}"]`).html(options);
            });
        });
        $('#sameAddress').on('change', function () {
            const isChecked = this.checked;
            $('.errorRemove').empty();
            const get = (type, cls) => $(`.${cls}[data-type="${type}"]`);
            if (isChecked) {
                get('op', 'country').val(get('reg', 'country').val()).trigger('change');
                setTimeout(() => get('op', 'state').val(get('reg', 'state').val()).trigger('change'), 300);
                setTimeout(() => get('op', 'city').val(get('reg', 'city').val()), 600);
                $('#operationalAddress').val($('#address').val());
                $('#operationalPostalCode').val($('#postalCode').val());
            } else {
                get('op', 'country').val('').trigger('change');
                get('op', 'state').html(`<option value=""><%= __("Select State") %></option>`);
                get('op', 'city').html(`<option value=""><%= __("Select City") %></option>`);
                $('#operationalAddress, #operationalPostalCode').val('');
            }
        });

        // Form submission
        $('#addCompany').on('input change', 'input, select', function () { $('.errorRemove', this.parentElement).empty(); });

        $('#addCompany').on('submit', function (e) {
            e.preventDefault();
            $('.errorRemove').empty();
            if ($('#sameAddress').is(':checked')) {
                const get = (type, cls) => $(`.${cls}[data-type="${type}"]`);
                get('op', 'country').val(get('reg', 'country').val());
                get('op', 'state').val(get('reg', 'state').val());
                get('op', 'city').val(get('reg', 'city').val());
                $('#operationalAddress').val($('#address').val());
                $('#operationalPostalCode').val($('#postalCode').val());
            }
            const formData = new FormData(this);
            $.post({ url: `<%= base_url + add_company %>`, data: formData, contentType: false, processData: false }).done(res => {
                if (res.errors) {
                    $('#loader').hide();
                    let firstErrorField = null;
                    for (const field in res.errors) {
                        const $input = $(this).find(`[name="${field}"]`);
                        $(this).find(`#${field}Error`).text(res.errors[field]);
                        if (!firstErrorField && $input.length) {
                            firstErrorField = $input;
                        }
                    }
                    if (firstErrorField) {
                        firstErrorField.focus();
                    }
                } else {
                    showMsg(res.success || res.error, res.success ? "success" : "danger");
                    if (res.success) setTimeout(() => window.location.href = `<%= base_url + company_list %>`, 1500);
                    if (res.error) setTimeout(() => $('#loader').hide(), 1500);
                }
            });
        });

        // Toast message
        function showMsg(msg, type = "danger") {
            const toast = $('.toast-container');
            toast.removeClass('d-none')
                .find('.toast-body').attr('class', `toast-body alert alert-${type}`).text(msg);
            setTimeout(() => toast.addClass('d-none').find('.toast-body').removeClass(`alert alert-${type}`).text(''), 1500);
        }

        // tan number
        $('#tanNumberCheck').on('change', function () {
            $('.tanNumber').toggleClass('d-none', !this.checked);
        });





    })
</script>