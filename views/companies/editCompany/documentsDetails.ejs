<%- include('../../common/header', title) %>
<div id="loader"></div>
<div class="row">
    <%- include('./businessSidebar')%>
    <div class="col-lg-9">
        <div class="tab-content text-muted mt-4 mt-md-0">
            <div class="card">
                <div class="card-body p-4">
                    <% let updateUrl = updatePer ? base_url + update_documents : '' %>
                    <form action="<%= updateUrl %>" id="updateDocuments" enctype="multipart/form-data">
                        <div class="row">
                            <span class="mb-3"> <h5><%=__("Business documents") %></h5></span>
                            <!-- tan number -->
                            <div class="form-check mb-3">
                                <input type="checkbox" name="company[tanNumberCheck]" id="tanNumberCheck" <%= documents.find(item => item.meta_key === 'tanNumberCheck' && item.meta_value === 'on') ? 'checked' : '' %>>
                                <label class="form-check-label" for="tanNumberCheck"><%=__("TAN Number") %></label>
                            </div>
                            <div class="col-md-6 mb-3 tanNumber <%= documents.find(item => item.meta_key === 'tanNumberCheck' && item.meta_value === 'on') ? '' : 'd-none' %>">

                                <label for="tanNumber" class="form-label"><%=__("TAN Number") %></label>
                                <input type="text" class="form-control" id="tanNumber" name="company[tanNumber]"
                                    placeholder="<%=__("TAN Number") %>" value="<%= documents.find(item => item.meta_key == 'tanNumber')?.meta_value  || '' %>">
                                <span id="tanNumberError" class="text-danger errorRemove"></span>
                            </div>
                        </div>
                        <div class="row">
                            <!-- GST Number -->
                            <div class="col-md-6 mb-3">
                                <label for="gstNumber"><%=__("GST Number") %><span class="text-danger"><%=__("*") %></span></label>
                                <input type="text" id="gstNumber" name="company[gstNumber]" class="form-control" placeholder="Enter GST Number" value="<%= documents.find(item => item.meta_key == 'gstNumber')?.meta_value  || '' %>">
                                <span id="company_gstNumberError" class="text-danger errorRemove"></span>
                            </div>
                            <%
                            // Helper function for preview logic
                            const getFileMeta = (key) => {
                            const doc = documents.find(d => d.meta_key === key);
                            const path = doc?.meta_value || '';
                            const fileName = path.split('/').pop();
                            const isPdf = fileName?.toLowerCase().endsWith('.pdf');
                            const url = path ? base_url + img_url + path : '';
                            return { path, fileName, isPdf, url };
                            };

                            const gst = getFileMeta('gstFile');
                            const pan = getFileMeta('panFile');
                            const aadhaarFront = getFileMeta('aadhaarFrontFile');
                            const aadhaarBack = getFileMeta('aadhaarBackFile');
                            const webLogo = {
                            path: data.logo || '',
                            fileName: (data.logo || '').split('/').pop(),
                            isPdf: (data.logo || '').toLowerCase().endsWith('.pdf'),
                            url: data.logo ? base_url + img_url + data.logo : ''
                            };
                            %>
                            <!-- GST Upload -->
                            <div class="col-md-6 mb-3">
                                <label for="gstNumber"><%=__("GST Document") %><span class="text-danger"><%=__("*") %></span></label>
                                <input type="file" class="form-control doc-upload" data-preview="#gstPreview" name="gstFile">
                                <div id="gstPreview" class="img-preview <%= gst.path ? '' : 'd-none' %>">
                                    <img src="<%= gst.isPdf ? '' : gst.url %>" class="img-thumbnail"style="<%= gst.isPdf ? 'display:none;' : 'display:inline;' %>">
                                    <div class="file-info"style="<%= gst.isPdf ? 'display:block;' : 'display:none;' %>"><%= gst.fileName %></div>
                                    <button type="button" class="btn-close-preview">×</button>
                                    <input type="hidden" name="gstFileOld" value="<%= gst.path %>">
                                    <input type="hidden" class="removeImg" name="removeGSTImg" value="0">
                                </div>
                                <span id="gstFileError" class="text-danger errorRemove"></span>
                            </div>

                            <!-- PAN Number -->
                          <!-- PAN Number -->
                            <div class="col-md-6 mb-3">
                                <label for="panNumber"><%=__("PAN Number") %><span class="text-danger"><%=__("*") %></span></label>
                                <input type="text" id="panNumber" name="company[panNumber]" id="panNumber" class="form-control" placeholder="Enter PAN Number" value="<%= documents.find(item => item.meta_key == 'panNumber')?.meta_value  || '' %>">
                                <span id="company_panNumberError" class="text-danger errorRemove"></span>
                            </div>

                            <!-- PAN Upload -->
                            <div class="col-md-6 mb-3">
                                <label for="panNumber"><%=__("PAN Document") %><span class="text-danger"><%=__("*") %></span></label>
                                <input type="file" class="form-control doc-upload" data-preview="#panPreview" name="panFile">
                               <div id="panPreview" class="img-preview <%= pan.path ? '' : 'd-none' %>">
                                    <% if (pan.isPdf) { %>
                                    <div class="file-info" style="display: block;"><%= pan.fileName %></div>
                                    <% } else { %>
                                    <img src="<%= pan.url %>" class="img-thumbnail" style="display: inline;">
                                    <div class="file-info" style="display: none;"></div>
                                    <% } %>
                                    <button type="button" class="btn-close-preview">×</button>
                                    <input type="hidden" name="panFileOld" value="<%= pan.path %>">
                                     <input type="hidden" class="removeImg" name="removePanImg" value="0">
                                </div>
                                <span id="panFileError" class="text-danger errorRemove"></span>
                            </div>
                            <!-- Aadhaar Front Upload -->
                           <div class="col-md-6 mb-3">
                                <label><%=__("Aadhaar Card (Front)") %><span class="text-danger"><%=__("*") %></span></label>
                                <input type="file" class="form-control doc-upload" data-preview="#aadhaarFrontPreview" name="aadhaarFront">
                                <div id="aadhaarFrontPreview" class="img-preview <%= aadhaarFront.path ? '' : 'd-none' %>">
                                    <img src="<%= aadhaarFront.isPdf ? '' : aadhaarFront.url %>" class="img-thumbnail"style="<%= aadhaarFront.isPdf ? 'display:none;' : 'display:inline;' %>">
                                    <div class="file-info"style="<%= aadhaarFront.isPdf ? 'display:block;' : 'display:none;' %>"><%= aadhaarFront.fileName %></div>
                                    <button type="button" class="btn-close-preview">×</button>
                                    <input type="hidden" name="aadhaarFrontOld" value="<%= aadhaarFront.path %>">
                                    <input type="hidden" class="removeImg" name="removeAdhaarFrontImg" value="0">
                                </div>
                                <span id="aadhaarFrontError" class="text-danger errorRemove"></span>
                            </div>

                            <!-- Aadhaar Back Upload -->
                        <div class="col-md-6 mb-3">
                            <label><%=__("Aadhaar Card (Back)") %><span class="text-danger"><%=__("*") %></span></label>
                            <input type="file" class="form-control doc-upload" data-preview="#aadhaarBackPreview" name="aadhaarBack">
                            <div id="aadhaarBackPreview" class="img-preview <%= aadhaarBack.path ? '' : 'd-none' %>">
                                <img src="<%= aadhaarBack.isPdf ? '' : aadhaarBack.url %>" class="img-thumbnail"style="<%= aadhaarBack.isPdf ? 'display:none;' : 'display:inline;' %>">
                                <div class="file-info"style="<%= aadhaarBack.isPdf ? 'display:block;' : 'display:none;' %>"><%= aadhaarBack.fileName %></div>
                                <button type="button" class="btn-close-preview">×</button>
                                <input type="hidden" name="aadhaarBackOld" value="<%= aadhaarBack.path %>">
                                <input type="hidden" class="removeImg" name="removeAdhaarBackImg" value="0">
                            </div>
                            <span id="aadhaarBackError" class="text-danger errorRemove"></span>
                        </div>

                            <!-- website logo -->
                        <div class="col-md-6 mb-3">
                            <label><%=__("Website Logo") %></label>
                            <input type="file" class="form-control doc-upload" data-preview="#websiteLogoPreview" name="websiteLogo" id="websiteLogo">
                            <div id="websiteLogoPreview" class="img-preview <%= webLogo.path ? '' : 'd-none' %>">
                                <img src="<%= webLogo.isPdf ? '' : webLogo.url %>" class="img-thumbnail"style="<%= webLogo.isPdf ? 'display:none;' : 'display:inline;' %>">
                                <div class="file-info"style="<%= webLogo.isPdf ? 'display:block;' : 'display:none;' %>"><%= webLogo.fileName %></div>
                                <button type="button" class="btn-close-preview">×</button>
                                <input type="hidden" name="websiteLogoOld" value="<%= webLogo.path %>">
                                <input type="hidden" class="removeImg" name="removeWebsiteLogoImg" value="0">
                            </div>
                        </div>
                        </div>
                        <% if(updatePer) { %>
                        <div class="float-end">
                            <button class="btn btn-primary" type="submit"><%=__("Submit") %></button>
                        </div>
                        <% } %>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<%- include('../../common/footer') %>
<script>
$(document).on('change', '.doc-upload', function () {
  const fileInput = this;
  const file = fileInput.files[0];
  const previewId = $(this).data('preview');
  const previewBox = $(previewId);
  const previewImg = previewBox.find('img');
  const previewText = previewBox.find('.file-info');
  const errorSpan = $(fileInput).siblings('span.text-danger');

  // Reset previous state
  errorSpan.text('');
  previewImg.hide().attr('src', '');
  previewText.text('').hide();
  previewBox.addClass('d-none');

  if (!file) return;

  const fileType = file.type;
  const fileSizeMB = file.size / (1024 * 1024); 
  const fileName = file.name;
  const validImageTypes = ['image/jpeg', 'image/png', 'image/jpg'];
  const validPdfType = 'application/pdf';

  if (fileSizeMB > 2) {
    errorSpan.text(`<%= __("File size must be less than or equal to 2MB.") %>`);
    $(fileInput).val('');
    return;
  }

  if (validImageTypes.includes(fileType)) {
    const reader = new FileReader();
    reader.onload = function (e) {
      const img = new Image();
      img.onload = function () {
        // ✅ Image is valid and loaded
        previewImg.attr('src', e.target.result).show();
        previewText.hide();
        previewBox.removeClass('d-none');
      };
      img.onerror = function () {
        // ❌ Invalid or corrupted image
        errorSpan.text(`<%= __("The selected image could not be displayed. It may be corrupted.") %>`);
        $(fileInput).val('');
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  } else if (fileType === validPdfType) {
    // Show file name for PDF
    previewImg.hide();
    previewText.text(fileName).show();
    previewBox.removeClass('d-none');
  } else {
    // Unsupported file type
    errorSpan.text(`<%= __("Only JPG, PNG, and PDF files are allowed.") %>`);
    $(fileInput).val('');
  }
});

// Clear preview when clicking close button
$(document).on('click', '.btn-close-preview', function () {
  const previewBox = $(this).closest('.img-preview');
  const previewId = previewBox.attr('id');
  const fileInput = $(`input[data-preview="#${previewId}"]`);
  const errorSpan = fileInput.siblings('span.text-danger');

  // Reset everything
  previewBox.addClass('d-none');
  previewBox.find('img').attr('src', '').hide();
  previewBox.find('.file-info').text('').hide();
  fileInput.val('');
  errorSpan.text('');
  previewBox.find('.removeImg').val('1');
});
</script>

<script>
    $(document).ready(function () {
        setTimeout(() => $('#loader').hide(), 300);
        
        //number validation
        $(".number_validation").on("input", e => e.target.value = e.target.value.replace(/\D/g, ''));
        $('#tanNumberCheck').on('change', function () {
            $('.tanNumber').toggleClass('d-none', !this.checked);
        });
        // error remove when key text and change select
        $('#updateDocuments').on('input change', 'input, select', e => $('.errorRemove', e.target.parentElement).empty());
        // form submit
        $('#updateDocuments').submit(function (e) {
            e.preventDefault();
            $('#loader').show();
             const formData = new FormData(this);
            $.post({ url: $(this).attr('action'),  data: formData, contentType: false, processData: false}).done(res => {
                if (res.errors) {
                    $('#loader').hide();
                    let firstErrorField = null;
                    for (const field in res.errors) {
                        const normalizedField = field.replace(/\[|\]/g, '_');
                        const $input = $(this).find(`[name="${field}"]`);
                        const $error = $(`#${normalizedField}Error`);
                        $error.text(res.errors[field]);
                        if (!firstErrorField && $input.length) {
                            firstErrorField = $input;
                        }
                    }
                    if (firstErrorField) {
                        firstErrorField.focus();
                    }
                } else {
                    showMsg(res.success || res.error, res.success ? "success" : "danger");
                    if (res.success) setTimeout(() => $('#loader').hide(), location.reload(), 1500);
                    if (res.error) setTimeout(() => $('#loader').hide(), 1500);
                }
            });
        });

        // msg show
        function showMsg(msg, type = "danger") {
            const toast = $('.toast-container');
            toast.removeClass('d-none').find('.toast-body').attr('class', `toast-body alert alert-${type}`).text(msg);
            setTimeout(() => toast.addClass('d-none').find('.toast-body').removeClass(`alert alert-${type}`).text(''), 1500);
        }

    })    
</script>